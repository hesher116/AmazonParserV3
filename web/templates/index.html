<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Multi-Agent Parser</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Amazon Multi-Agent Parser</h1>
        </header>

        <main>
            <div class="grid">
                <!-- Left panel: New Task -->
                <section class="panel">
                    <div class="panel-header">Start New Task</div>
                    <div class="panel-content">
                        <form id="parseForm" style="display: flex; flex-direction: column; flex: 1; min-height: 0;">
                            <div class="form-group">
                                <label for="url">Amazon Product URL</label>
                                <input 
                                    type="url" 
                                    id="url" 
                                    name="url" 
                                    placeholder="https://www.amazon.com/..."
                                    required
                                >
                            </div>

                            <div class="form-group">
                                <label for="openai_api_key">OpenAI API Key (для OCR)</label>
                                <input 
                                    type="password" 
                                    id="openai_api_key" 
                                    name="openai_api_key" 
                                    placeholder="sk-proj-... (або залиште порожнім, якщо в .env)"
                                >
                                <small style="display: block; color: var(--text-secondary); margin-top: 6px; font-size: 0.85rem; line-height: 1.4;">
                                    Потрібен для розпізнавання тексту з зображень (OCR). Можна вказати тут або в .env файлі.
                                </small>
                            </div>

                            <div class="form-group">
                                <label>Categories to Parse</label>
                                <div class="checkbox-group">
                                    <div class="checkbox-section">
                                        <div class="checkbox-section-title">Images</div>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="select_all_images" onchange="toggleAllImages(this)">
                                            <span class="checkmark"></span>
                                            <strong>Select All Images</strong>
                                        </label>
                                        <div class="image-ocr-row">
                                            <label class="checkbox-label" style="flex: 1;">
                                                <input type="checkbox" name="images_hero" id="images_hero" class="image-checkbox" onchange="updateSelectAllImages(); toggleOCRCheckbox('ocr_hero', this.checked)">
                                                <span class="checkmark"></span>
                                                Hero Image
                                            </label>
                                            <label class="checkbox-label ocr-sub-checkbox">
                                                <input type="checkbox" name="ocr_hero" id="ocr_hero" class="ocr-checkbox" disabled onchange="validateOCR()">
                                                <span class="checkmark"></span>
                                                <small>OCR</small>
                                            </label>
                                        </div>
                                        <div class="image-ocr-row">
                                            <label class="checkbox-label" style="flex: 1;">
                                                <input type="checkbox" name="images_gallery" id="images_gallery" class="image-checkbox" onchange="updateSelectAllImages(); toggleOCRCheckbox('ocr_gallery', this.checked)">
                                                <span class="checkmark"></span>
                                                Product Gallery
                                            </label>
                                            <label class="checkbox-label ocr-sub-checkbox">
                                                <input type="checkbox" name="ocr_gallery" id="ocr_gallery" class="ocr-checkbox" disabled onchange="validateOCR()">
                                                <span class="checkmark"></span>
                                                <small>OCR</small>
                                            </label>
                                        </div>
                                        <div class="image-ocr-row">
                                            <label class="checkbox-label" style="flex: 1;">
                                                <input type="checkbox" name="images_aplus_product" id="images_aplus_product" class="image-checkbox" onchange="updateSelectAllImages(); toggleOCRCheckbox('ocr_aplus_product', this.checked)">
                                                <span class="checkmark"></span>
                                                A+ Product Description
                                            </label>
                                            <label class="checkbox-label ocr-sub-checkbox">
                                                <input type="checkbox" name="ocr_aplus_product" id="ocr_aplus_product" class="ocr-checkbox" disabled onchange="validateOCR()">
                                                <span class="checkmark"></span>
                                                <small>OCR</small>
                                            </label>
                                        </div>
                                        <div class="image-ocr-row">
                                            <label class="checkbox-label" style="flex: 1;">
                                                <input type="checkbox" name="images_aplus_brand" id="images_aplus_brand" class="image-checkbox" onchange="updateSelectAllImages(); toggleOCRCheckbox('ocr_aplus_brand', this.checked)">
                                                <span class="checkmark"></span>
                                                A+ Brand Story
                                            </label>
                                            <label class="checkbox-label ocr-sub-checkbox">
                                                <input type="checkbox" name="ocr_aplus_brand" id="ocr_aplus_brand" class="ocr-checkbox" disabled onchange="validateOCR()">
                                                <span class="checkmark"></span>
                                                <small>OCR</small>
                                            </label>
                                        </div>
                                        <div class="image-ocr-row">
                                            <label class="checkbox-label" style="flex: 1;">
                                                <input type="checkbox" name="images_aplus_manufacturer" id="images_aplus_manufacturer" class="image-checkbox" onchange="updateSelectAllImages(); toggleOCRCheckbox('ocr_aplus_manufacturer', this.checked)">
                                                <span class="checkmark"></span>
                                                A+ From the Manufacturer
                                            </label>
                                            <label class="checkbox-label ocr-sub-checkbox">
                                                <input type="checkbox" name="ocr_aplus_manufacturer" id="ocr_aplus_manufacturer" class="ocr-checkbox" disabled onchange="validateOCR()">
                                                <span class="checkmark"></span>
                                                <small>OCR</small>
                                            </label>
                                        </div>
                                    </div>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="text">
                                        <span class="checkmark"></span>
                                        Product Description + Q&A (якщо існує)
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="reviews">
                                        <span class="checkmark"></span>
                                        Customer Reviews
                                    </label>
                                </div>
                            </div>

                            <button type="submit" class="btn-primary" id="submitBtn">
                                Start Parsing
                            </button>
                        </form>

                        <!-- Progress section -->
                        <div id="progressSection" class="progress-section hidden">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <p class="progress-text" id="progressText">Starting...</p>
                            <div id="errorMessages" class="error-messages"></div>
                        </div>
                    </div>
                </section>

                <!-- Right panel: Recent Tasks -->
                <section class="panel">
                    <div class="panel-header">Recent Tasks</div>
                    <div class="panel-content">
                        <div class="tasks-list" id="tasksList">
                        {% for task in tasks %}
                        <div class="task-item" data-task-id="{{ task.id }}">
                            <div class="task-header">
                                <span class="task-name">{{ task.product_name or 'Loading...' }}</span>
                                <span class="task-status status-{{ task.status }}">
                                    {{ task.status | upper }}
                                </span>
                            </div>
                            <div class="task-meta">
                                ID: {{ task.id }} | {{ task.created_at[:16] if task.created_at else '' }}
                                {% if task.results and task.results.processing_time_formatted %}
                                | Time: {{ task.results.processing_time_formatted }}
                                {% endif %}
                            </div>
                            {% if task.results %}
                            <div class="task-results">
                                {% set r = task.results %}
                                {% set config = task.config if task.config else {} %}
                                {% if config.text and r.price %}
                                <span title="Price" class="task-price">Price: ${{ r.price }}</span>
                                {% endif %}
                                <span title="Hero images">Hero: {{ r.images.hero if r.images and r.images.hero else 0 }}</span>
                                <span title="Gallery images">Gallery: {{ r.images.gallery if r.images and r.images.gallery else 0 }}</span>
                                <span title="A+ Product images">A+ Prod: {{ r.images.aplus_product if r.images and r.images.aplus_product else 0 }}</span>
                                <span title="A+ Brand images">A+ Brand: {{ r.images.aplus_brand if r.images and r.images.aplus_brand else 0 }}</span>
                                <span title="A+ Manufacturer images">A+ Mfr: {{ r.images.aplus_manufacturer if r.images and r.images.aplus_manufacturer else 0 }}</span>
                                <span title="Reviews">Reviews: {{ r.reviews_count if r.reviews_count else 0 }}</span>
                                <span title="Q&A pairs">Q&A: {{ r.qa_count if r.qa_count else 0 }}</span>
                                {% if r.ocr_metrics %}
                                <span title="OCR processed images">OCR: {{ r.ocr_metrics.processed or 0 }}/{{ r.ocr_metrics.total_images or 0 }} images ({{ r.ocr_metrics.time_seconds or 0 }}s)</span>
                                <span title="OCR tokens used">OCR: {% if r.ocr_metrics.tokens and r.ocr_metrics.tokens.total_tokens %}{% set t = r.ocr_metrics.tokens.total_tokens %}{% if t >= 1000000 %}{{ "%.1f"|format(t / 1000000) }}M{% elif t >= 1000 %}{{ "%.1f"|format(t / 1000) }}k{% else %}{{ t }}{% endif %}{% else %}0{% endif %} tokens</span>
                                {% else %}
                                <span title="OCR processed images">OCR: 0/0 images (0s)</span>
                                <span title="OCR tokens used">OCR: 0 tokens</span>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% if task.error_message %}
                            <div class="task-error">{{ task.error_message[:100] }}...</div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="empty-state">No tasks yet. Start your first parsing!</div>
                        {% endfor %}
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        function toggleAllImages(checkbox) {
            const imageCheckboxes = document.querySelectorAll('.image-checkbox');
            imageCheckboxes.forEach(cb => {
                const wasChecked = cb.checked;
                cb.checked = checkbox.checked;
                // Update corresponding OCR checkbox
                const imageId = cb.id;
                if (imageId) {
                    const ocrId = imageId.replace('images_', 'ocr_');
                    toggleOCRCheckbox(ocrId, checkbox.checked);
                }
            });
        }
        
        function updateSelectAllImages() {
            const imageCheckboxes = document.querySelectorAll('.image-checkbox');
            const selectAllCheckbox = document.getElementById('select_all_images');
            const allChecked = Array.from(imageCheckboxes).every(cb => cb.checked);
            const someChecked = Array.from(imageCheckboxes).some(cb => cb.checked);
            
            // Update "Select All Images" checkbox state
            if (allChecked && imageCheckboxes.length > 0) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else if (someChecked) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
        }
        
        function toggleOCRCheckbox(ocrCheckboxId, enabled) {
            const ocrCheckbox = document.getElementById(ocrCheckboxId);
            if (ocrCheckbox) {
                ocrCheckbox.disabled = !enabled;
                if (!enabled) {
                    ocrCheckbox.checked = false;
                }
                // Update opacity
                const ocrLabel = ocrCheckbox.closest('.ocr-sub-checkbox');
                if (ocrLabel) {
                    ocrLabel.style.opacity = enabled ? '1' : '0.7';
                }
            }
        }
        
        function validateOCR() {
            const ocrCheckboxes = document.querySelectorAll('.ocr-checkbox:not([disabled])');
            const apiKeyInput = document.getElementById('openai_api_key');
            const hasOCRSelected = Array.from(ocrCheckboxes).some(cb => cb.checked);
            
            if (hasOCRSelected) {
                // If OCR is selected, make API key field more visible (optional validation)
                apiKeyInput.style.borderColor = '#ff9800';
            } else {
                apiKeyInput.style.borderColor = '';
            }
        }
        const parseForm = document.getElementById('parseForm');
        const submitBtn = document.getElementById('submitBtn');
        const progressSection = document.getElementById('progressSection');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const tasksList = document.getElementById('tasksList');

        let currentTaskId = null;
        let pollInterval = null;

        parseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Note: API key validation is done on backend (checks both form and .env file)
            // Frontend validation removed to allow .env file usage
            
            const formData = new FormData(parseForm);
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Starting...';
                submitBtn.style.display = 'none'; // Hide button when progress starts
                
                const response = await fetch('/start_parsing', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Start Parsing';
                    submitBtn.style.display = 'block'; // Show button on error
                    return;
                }
                
                currentTaskId = data.task_id;
                progressSection.classList.remove('hidden');
                progressFill.style.width = '0%';
                progressText.textContent = 'Starting...';
                
                // Start polling for progress
                startProgressPolling();
                
            } catch (error) {
                alert('Error: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Start Parsing';
            }
        });

        function startProgressPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
            }
            
            pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/task/${currentTaskId}/status`);
                    const data = await response.json();
                    
                    // Update progress
                    if (data.progress_percent !== undefined) {
                        progressFill.style.width = data.progress_percent + '%';
                    }
                    if (data.progress_message) {
                        progressText.textContent = data.progress_message;
                    }
                    
                    // Display OCR metrics and errors
                    const errorMessagesDiv = document.getElementById('errorMessages');
                    let messagesHtml = '';
                    
                    // Display OCR metrics if available
                    if (data.results && data.results.ocr_metrics) {
                        const metrics = data.results.ocr_metrics;
                        const statusClass = metrics.failed > 0 ? 'warning' : 'success';
                        messagesHtml += `<div class="ocr-metrics ${statusClass}">OCR: ${metrics.processed}/${metrics.total_images} images (${metrics.time_seconds}s)${metrics.failed > 0 ? `, ${metrics.failed} failed` : ''}</div>`;
                    }
                    
                    // Display errors if any
                    if (data.results && data.results.errors && data.results.errors.length > 0) {
                        const errorItems = data.results.errors
                            .filter(err => err && err.trim())
                            .map(err => `<div class="error-item">${err}</div>`)
                            .join('');
                        messagesHtml += errorItems;
                    }
                    
                    errorMessagesDiv.innerHTML = messagesHtml;
                    
                    // Check if task is complete
                    if (data.status === 'completed' || data.status === 'failed') {
                        clearInterval(pollInterval);
                        pollInterval = null;
                        
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Start Parsing';
                        
                        if (data.status === 'completed') {
                            progressFill.style.width = '100%';
                            progressText.textContent = 'Completed!';
                            progressFill.classList.add('success');
                        } else {
                            progressText.textContent = 'Failed: ' + (data.error_message || 'Unknown error');
                            progressFill.classList.add('error');
                        }
                        
                        // Refresh task list
                        refreshTaskList();
                        
                        // Hide progress after delay and show button again
                        setTimeout(() => {
                            progressSection.classList.add('hidden');
                            progressFill.classList.remove('success', 'error');
                            errorMessagesDiv.innerHTML = '';
                            submitBtn.style.display = 'block'; // Show button again
                        }, 5000);
                    }
                    
                } catch (error) {
                    console.error('Error polling status:', error);
                }
            }, 1000);
        }

        async function refreshTaskList() {
            try {
                const response = await fetch('/tasks');
                const tasks = await response.json();
                
                if (tasks.length === 0) {
                    tasksList.innerHTML = '<div class="empty-state">No tasks yet. Start your first parsing!</div>';
                    return;
                }
                
                tasksList.innerHTML = tasks.map(task => {
                    // Safely extract image counts - handle both number and array cases
                    let hero = 0, gallery = 0, aplus_product = 0, aplus_brand = 0, aplus_manufacturer = 0;
                    
                    if (task.results && task.results.images) {
                        const images = task.results.images;
                        // Handle both number (count) and array (list) formats
                        hero = typeof images.hero === 'number' ? images.hero : (Array.isArray(images.hero) ? images.hero.length : 0);
                        gallery = typeof images.gallery === 'number' ? images.gallery : (Array.isArray(images.gallery) ? images.gallery.length : 0);
                        aplus_product = typeof images.aplus_product === 'number' ? images.aplus_product : (Array.isArray(images.aplus_product) ? images.aplus_product.length : 0);
                        aplus_brand = typeof images.aplus_brand === 'number' ? images.aplus_brand : (Array.isArray(images.aplus_brand) ? images.aplus_brand.length : 0);
                        aplus_manufacturer = typeof images.aplus_manufacturer === 'number' ? images.aplus_manufacturer : (Array.isArray(images.aplus_manufacturer) ? images.aplus_manufacturer.length : 0);
                    }
                    
                    return `
                    <div class="task-item" data-task-id="${task.id}">
                        <div class="task-header">
                            <span class="task-name">${task.product_name || 'Loading...'}</span>
                            <span class="task-status status-${task.status}">
                                ${task.status.toUpperCase()}
                            </span>
                        </div>
                        <div class="task-meta">
                            ID: ${task.id} | ${task.created_at ? task.created_at.slice(0, 16) : ''}
                            ${task.results?.processing_time_formatted ? ` | Time: ${task.results.processing_time_formatted}` : ''}
                        </div>
                        ${task.results ? `
                        <div class="task-results">
                            ${task.config?.text && task.results.price ? `<span title="Price" class="task-price">Price: $${task.results.price}</span>` : ''}
                            <span title="Hero images">Hero: ${hero}</span>
                            <span title="Gallery images">Gallery: ${gallery}</span>
                            <span title="A+ Product images">A+ Prod: ${aplus_product}</span>
                            <span title="A+ Brand images">A+ Brand: ${aplus_brand}</span>
                            <span title="A+ Manufacturer images">A+ Mfr: ${aplus_manufacturer}</span>
                            <span title="Reviews">Reviews: ${task.results.reviews_count || 0}</span>
                            <span title="Q&A pairs">Q&A: ${task.results.qa_count || 0}</span>
                            ${task.results.ocr_metrics ? `
                            <span title="OCR processed images">OCR: ${task.results.ocr_metrics.processed || 0}/${task.results.ocr_metrics.total_images || 0} images (${task.results.ocr_metrics.time_seconds || 0}s)</span>
                            <span title="OCR tokens used">OCR: ${(() => {
                                const tokens = task.results.ocr_metrics.tokens && task.results.ocr_metrics.tokens.total_tokens ? task.results.ocr_metrics.tokens.total_tokens : 0;
                                if (tokens >= 1000000) return (tokens / 1000000).toFixed(1) + 'M';
                                if (tokens >= 1000) return (tokens / 1000).toFixed(1) + 'k';
                                return tokens;
                            })()} tokens</span>
                            ` : `
                            <span title="OCR processed images">OCR: 0/0 images (0s)</span>
                            <span title="OCR tokens used">OCR: 0 tokens</span>
                            `}
                        </div>
                        ` : ''}
                        ${task.error_message ? `
                        <div class="task-error">${task.error_message.slice(0, 100)}...</div>
                        ` : ''}
                    </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error refreshing tasks:', error);
            }
        }

        // Auto-refresh task list every 5 seconds
        setInterval(refreshTaskList, 5000);
    </script>
</body>
</html>

