<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Multi-Agent Parser</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Amazon Multi-Agent Parser</h1>
        </header>

        <main>
            <div class="grid">
                <!-- Left panel: New Task -->
                <section class="panel">
                    <div class="panel-header">Start New Task</div>
                    <div class="panel-content">
                        <form id="parseForm">
                            <div class="form-group">
                                <label for="url">Amazon Product URL</label>
                                <input 
                                    type="url" 
                                    id="url" 
                                    name="url" 
                                    placeholder="https://www.amazon.com/..."
                                    required
                                >
                            </div>

                            <div class="form-group">
                                <label>Categories to Parse</label>
                                <div class="checkbox-group">
                                    <div class="checkbox-section">
                                        <div class="checkbox-section-title">Images</div>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="select_all_images" onchange="toggleAllImages(this)">
                                            <span class="checkmark"></span>
                                            <strong>Select All Images</strong>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" name="images_hero" class="image-checkbox">
                                            <span class="checkmark"></span>
                                            Hero Image
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" name="images_gallery" class="image-checkbox">
                                            <span class="checkmark"></span>
                                            Product Gallery
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" name="images_aplus_product" class="image-checkbox">
                                            <span class="checkmark"></span>
                                            A+ Product Description
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" name="images_aplus_brand" class="image-checkbox">
                                            <span class="checkmark"></span>
                                            A+ Brand Story
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" name="images_aplus_manufacturer" class="image-checkbox">
                                            <span class="checkmark"></span>
                                            A+ From the Manufacturer
                                        </label>
                                    </div>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="text">
                                        <span class="checkmark"></span>
                                        Product Description + Q&A (якщо існує)
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="reviews">
                                        <span class="checkmark"></span>
                                        Customer Reviews
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="variants">
                                        <span class="checkmark"></span>
                                        Variants (Color/Size/Style)
                                    </label>
                                </div>
                            </div>

                            <button type="submit" class="btn-primary" id="submitBtn">
                                Start Parsing
                            </button>
                        </form>

                        <!-- Progress section -->
                        <div id="progressSection" class="progress-section hidden">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <p class="progress-text" id="progressText">Starting...</p>
                        </div>
                    </div>
                </section>

                <!-- Right panel: Recent Tasks -->
                <section class="panel">
                    <div class="panel-header">Recent Tasks</div>
                    <div class="panel-content tasks-list" id="tasksList">
                        {% for task in tasks %}
                        <div class="task-item" data-task-id="{{ task.id }}">
                            <div class="task-header">
                                <span class="task-name">{{ task.product_name or 'Loading...' }}</span>
                                <span class="task-status status-{{ task.status }}">
                                    {{ task.status | upper }}
                                </span>
                            </div>
                            <div class="task-meta">
                                ID: {{ task.id }} | {{ task.created_at[:16] if task.created_at else '' }}
                                {% if task.results and task.results.processing_time_formatted %}
                                | Time: {{ task.results.processing_time_formatted }}
                                {% endif %}
                            </div>
                            {% if task.results %}
                            <div class="task-results">
                                {% set r = task.results %}
                                <span title="Hero images">Hero: {{ r.images.hero if r.images and r.images.hero else 0 }}</span>
                                <span title="Gallery images">Gallery: {{ r.images.gallery if r.images and r.images.gallery else 0 }}</span>
                                <span title="A+ Product images">A+ Prod: {{ r.images.aplus_product if r.images and r.images.aplus_product else 0 }}</span>
                                <span title="A+ Brand images">A+ Brand: {{ r.images.aplus_brand if r.images and r.images.aplus_brand else 0 }}</span>
                                <span title="A+ Manufacturer images">A+ Mfr: {{ r.images.aplus_manufacturer if r.images and r.images.aplus_manufacturer else 0 }}</span>
                                <span title="Reviews">Reviews: {{ r.reviews_count if r.reviews_count else 0 }}</span>
                                <span title="Q&A pairs">Q&A: {{ r.qa_count if r.qa_count else 0 }}</span>
                                <span title="Variants">Variants: {{ r.variants_count if r.variants_count else 0 }}</span>
                            </div>
                            {% endif %}
                            {% if task.error_message %}
                            <div class="task-error">{{ task.error_message[:100] }}...</div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="empty-state">No tasks yet. Start your first parsing!</div>
                        {% endfor %}
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        function toggleAllImages(checkbox) {
            const imageCheckboxes = document.querySelectorAll('.image-checkbox');
            imageCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }
        const parseForm = document.getElementById('parseForm');
        const submitBtn = document.getElementById('submitBtn');
        const progressSection = document.getElementById('progressSection');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const tasksList = document.getElementById('tasksList');

        let currentTaskId = null;
        let pollInterval = null;

        parseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(parseForm);
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Starting...';
                
                const response = await fetch('/start_parsing', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Start Parsing';
                    return;
                }
                
                currentTaskId = data.task_id;
                progressSection.classList.remove('hidden');
                progressFill.style.width = '0%';
                progressText.textContent = 'Starting...';
                
                // Start polling for progress
                startProgressPolling();
                
            } catch (error) {
                alert('Error: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Start Parsing';
            }
        });

        function startProgressPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
            }
            
            pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/task/${currentTaskId}/status`);
                    const data = await response.json();
                    
                    // Update progress
                    if (data.progress_percent !== undefined) {
                        progressFill.style.width = data.progress_percent + '%';
                    }
                    if (data.progress_message) {
                        progressText.textContent = data.progress_message;
                    }
                    
                    // Check if task is complete
                    if (data.status === 'completed' || data.status === 'failed') {
                        clearInterval(pollInterval);
                        pollInterval = null;
                        
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Start Parsing';
                        
                        if (data.status === 'completed') {
                            progressFill.style.width = '100%';
                            progressText.textContent = 'Completed!';
                            progressFill.classList.add('success');
                        } else {
                            progressText.textContent = 'Failed: ' + (data.error_message || 'Unknown error');
                            progressFill.classList.add('error');
                        }
                        
                        // Refresh task list
                        refreshTaskList();
                        
                        // Hide progress after delay
                        setTimeout(() => {
                            progressSection.classList.add('hidden');
                            progressFill.classList.remove('success', 'error');
                        }, 3000);
                    }
                    
                } catch (error) {
                    console.error('Error polling status:', error);
                }
            }, 1000);
        }

        async function refreshTaskList() {
            try {
                const response = await fetch('/tasks');
                const tasks = await response.json();
                
                if (tasks.length === 0) {
                    tasksList.innerHTML = '<div class="empty-state">No tasks yet. Start your first parsing!</div>';
                    return;
                }
                
                tasksList.innerHTML = tasks.map(task => {
                    // Safely extract image counts - handle both number and array cases
                    let hero = 0, gallery = 0, aplus_product = 0, aplus_brand = 0;
                    
                    if (task.results && task.results.images) {
                        const images = task.results.images;
                        // Handle both number (count) and array (list) formats
                        hero = typeof images.hero === 'number' ? images.hero : (Array.isArray(images.hero) ? images.hero.length : 0);
                        gallery = typeof images.gallery === 'number' ? images.gallery : (Array.isArray(images.gallery) ? images.gallery.length : 0);
                        aplus_product = typeof images.aplus_product === 'number' ? images.aplus_product : (Array.isArray(images.aplus_product) ? images.aplus_product.length : 0);
                        aplus_brand = typeof images.aplus_brand === 'number' ? images.aplus_brand : (Array.isArray(images.aplus_brand) ? images.aplus_brand.length : 0);
                        aplus_manufacturer = typeof images.aplus_manufacturer === 'number' ? images.aplus_manufacturer : (Array.isArray(images.aplus_manufacturer) ? images.aplus_manufacturer.length : 0);
                    }
                    
                    return `
                    <div class="task-item" data-task-id="${task.id}">
                        <div class="task-header">
                            <span class="task-name">${task.product_name || 'Loading...'}</span>
                            <span class="task-status status-${task.status}">
                                ${task.status.toUpperCase()}
                            </span>
                        </div>
                        <div class="task-meta">
                            ID: ${task.id} | ${task.created_at ? task.created_at.slice(0, 16) : ''}
                            ${task.results?.processing_time_formatted ? ` | Time: ${task.results.processing_time_formatted}` : ''}
                        </div>
                        ${task.results ? `
                        <div class="task-results">
                            <span title="Hero images">Hero: ${hero}</span>
                            <span title="Gallery images">Gallery: ${gallery}</span>
                            <span title="A+ Product images">A+ Prod: ${aplus_product}</span>
                            <span title="A+ Brand images">A+ Brand: ${aplus_brand}</span>
                            <span title="A+ Manufacturer images">A+ Mfr: ${aplus_manufacturer}</span>
                            <span title="Reviews">Reviews: ${task.results.reviews_count || 0}</span>
                            <span title="Q&A pairs">Q&A: ${task.results.qa_count || 0}</span>
                            <span title="Variants">Variants: ${task.results.variants_count || 0}</span>
                        </div>
                        ` : ''}
                        ${task.error_message ? `
                        <div class="task-error">${task.error_message.slice(0, 100)}...</div>
                        ` : ''}
                    </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error refreshing tasks:', error);
            }
        }

        // Auto-refresh task list every 5 seconds
        setInterval(refreshTaskList, 5000);
    </script>
</body>
</html>

