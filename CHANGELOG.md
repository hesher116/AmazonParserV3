# Changelog

Всі важливі зміни в проекті будуть документовані в цьому файлі.

Формат заснований на [Keep a Changelog](https://keepachangelog.com/uk/1.0.0/),
і цей проект дотримується [Semantic Versioning](https://semver.org/lang/uk/).

## [Unreleased]

### Додано

- **OCR функціональність з OpenAI Vision API**: 
  - Розпізнавання тексту з зображень (OCR TEXT)
  - Візуальний опис зображень (VISUAL) в структурованому форматі
  - Опціональна обробка для кожної категорії зображень (Hero, Gallery, A+ Product, A+ Brand, A+ Manufacturer)
  - Батч-обробка зображень (по 5 зображень) для оптимізації токенів
  - Автоматичне повторне оброблення невдалих зображень з експоненційним backoff
  - Метрики OCR в UI (кількість оброблених зображень, час, витрачені токени)
  - Підтримка API ключа через UI або .env файл
- **Оптимізація OCR**:
  - Зменшення розміру зображень до 1024x1024 (зберігаючи пропорції) для економії токенів
  - Скорочений промпт (~60% економії токенів)
  - Зменшення max_tokens до 1500
  - Обробка rate limits з автоматичними затримками
- **Парсинг "Customers say"**: AI-згенерований підсумок відгуків в секції Customer Reviews
- **Парсинг "Top reviews from the United States"**: Заголовок секції топ відгуків
- **Покращений парсинг відгуків**: Підтримка BeautifulSoup та Selenium для всіх полів відгуків
- **Об'єднано Product Description та Q&A**: Q&A тепер парситься автоматично як частина Product Description
- **Оптимізація навігації**: Галерея чекається тільки коли потрібні зображення (економія ~3 секунди)
- **Оптимізація fallback до Selenium**: Зменшено час fallback з 2s до 0.5s на селектор
- **Чекання текстового контенту**: Додано чекання основних елементів перед збереженням DOM dump
- **Парсинг From the Brand**: Додано окремий парсинг секції "From the Brand"
- **Покращений парсинг Sustainability Features**: Витягування всієї інформації включаючи сертифікати
- **Парсинг Q&A в Product Description**: Автоматичне виявлення та форматування Q&A контенту
- **Метрики парсингу**: Відстеження успішності селекторів та fallback використання
- **Метрика Q&A count**: Відображення кількості Q&A пар в Recent Tasks

### Додано (попередні версії)

- **Модульна архітектура агентів парсингу зображень**:
  - `base_image_parser.py` - базовий клас зі спільною логікою
  - `hero_parser.py` - парсинг головного зображення
  - `gallery_parser.py` - парсинг галереї через JavaScript блок `ImageBlockATF`
  - `aplus_product_parser.py` - парсинг A+ Product Description
  - `aplus_brand_parser.py` - парсинг A+ Brand Story
  - `aplus_manufacturer_parser.py` - парсинг A+ From the Manufacturer з фільтрацією реклами за розміром
- **Оптимізація навігації**: `page_load_strategy="none"` + очікування тільки ключових елементів (3-6 сек)
- **JavaScript Block Parsing для Gallery**: Пряме витягування з `ImageBlockATF` замість кліків (5-6 сек замість 20-40)
- **DOM-парсинг для A+ контенту**: Всі зображення (включно з каруселями) витягуються напряму з DOM
- **Alt текст в DOCX**: Автоматичне витягування та додавання з правильним форматуванням
- **Обмеження MD5 кешу**: Автоматичне очищення при перевищенні `MD5_CACHE_MAX_SIZE`
- **Обмеження розміру зображень**: `MAX_IMAGE_SIZE` для запобігання завантаження великих файлів
- **Очищення старих задач**: Автоматичне видалення задач старших за `TASK_CLEANUP_DAYS`
- **Кешування селекторів**: Збереження успішних селекторів для швидшого пошуку
- **Логування продуктивності**: Метрики часу виконання для кожного агента
- **Конфігурація через .env**: `MAX_IMAGE_SIZE`, `MD5_CACHE_MAX_SIZE`, `TASK_CLEANUP_DAYS`, `SELECTOR_CACHE_ENABLED`, `PERFORMANCE_LOGGING`
- **UI метрики**: Відображення кількості зображень (hero, gallery, aplus_product, aplus_brand, aplus_manufacturer) та часу обробки в Recent Tasks
- **A+ Manufacturer Parser**: Новий агент для парсингу секції "From the manufacturer" з автоматичною фільтрацією рекламних зображень (150x300) за розміром
- **Кольорове логування**: Різні кольори для різних агентів та рівнів логування (INFO, WARNING, ERROR) для кращої читабельності
- **Швидка перевірка h2 заголовків**: Ранній вихід з парсингу A+ контенту, якщо відповідний заголовок не знайдено на сторінці

### Змінено

#### Оптимізація навігації (`core/browser_pool.py`)
- **Page Load Strategy**: Встановлено `page_load_strategy = 'none'` для швидшої навігації
  - `driver.get(url)` більше не чекає повного завантаження сторінки
  - Очікування тільки ключових елементів галереї: `#landingImage`, `#imgTagWrapperId img`, `#altImages img`
  - Результат: навігація 3-6 секунд замість 15-30+

#### Парсинг зображень (модульна архітектура)
- **Gallery Parser**: Перехід на JavaScript block parsing (`ImageBlockATF`) замість кліків по thumbnails
  - Витягування з `data.colorImages.initial` масиву
  - Результат: 5-6 секунд замість 20-40
- **A+ Parsers**: Прямий DOM-парсинг замість прокрутки каруселей
  - Всі зображення вже в DOM, зберігаємо порядок появи
  - Детекція каруселей через parent elements
  - Результат: 2-3 секунди замість 9-10
- **Високоякісні зображення**: Видалення всіх size indicators з URL для максимальної роздільності
  - Окрема обробка A+ URL (без змін, щоб уникнути 403)
- **Уніфікований метод**: `_extract_high_res_url_from_element()` в базовому класі
  - Пріоритет: `data-old-hires` → `data-a-dynamic-image` (JSON) → `data-src` → `src`
  - Фільтрація малих розмірів та SVG/іконок

#### Генерація DOCX (`core/docx_generator.py`)
- **Alt текст**: Автоматичне витягування та додавання з правильним форматуванням
  - Формат: "Опис з сайту: [текст]" (жирним, зліва)
  - Зберігання в словнику, передача через results
- **Порядок зображень**: Natural sorting для правильного порядку (1, 2, 3, ..., 10, 11)
- **Обробка помилок**: Конвертація через PIL для проблемних форматів (RGBA/P → RGB)

#### База даних (`core/database.py`)
- **Обробка великих JSON**: Truncation до 10MB з збереженням ключових даних
- **Автоматичне очищення**: Видалення старих задач через `cleanup_old_tasks()`
- **Правильна серіалізація**: Використання `default=str` для несеріалізованих об'єктів

#### Веб-інтерфейс (`web/templates/index.html`)
- **Окремі чекбокси**: Hero, Gallery, A+ Product, A+ Brand, A+ From the Manufacturer замість одного "Images"
- **"Select All Images"**: Чекбокс для автоматичного вибору всіх зображень
- **Метрики в Recent Tasks**: Відображення кількості зображень (включно з A+ Manufacturer) та часу обробки

#### Логування (`utils/logger.py`)
- **Кольорове форматування**: Різні кольори для кожного агента та рівня логування
  - Hero: яскравий блакитний, Gallery: яскравий синій, A+ Product: яскравий пурпурний
  - A+ Brand: яскравий зелений, A+ Manufacturer: яскравий жовтий
  - WARNING: яскравий жовтий, ERROR: яскравий червоний
- **Colorama**: Додано підтримку кольорового виводу через `colorama` (тільки для консолі, файлові логи без кольорів)

### Виправлено

- **Дублювання hero зображення в gallery**: Правильна дедуплікація через `_normalize_url_for_comparison()`
- **Низька якість зображень**: Видалення size indicators для максимальної роздільності
- **403 Forbidden для A+ зображень**: Окрема обробка A+ URL без змін
- **Порядок зображень в A+**: Збереження порядку появи на сайті (regular + carousel interleaved)
- **Alt текст не відображався в DOCX**: Правильна передача через results та форматування
- **Метрики показували 0**: Правильний підрахунок та відображення в UI
- **JSON serialization errors**: Додано `default=str` та truncation для великих результатів
- **Валідатор перевіряв невибрані категорії**: Тепер перевіряє тільки вибрані категорії
- **DOCX не створювався для тільки Reviews**: Тепер створюється навіть якщо вибрано тільки Customer Reviews
- **Помилки відступів в text_utils.py**: Виправлено всі IndentationError
- **Помилка "html referenced before assignment"**: Виправлено в extract_list_items та extract_table_data

### Оптимізовано

- **OCR обробка зображень**:
  - Зменшення розміру зображень до 1024x1024 (зберігаючи пропорції) - економія ~75% токенів на зображення
  - Скорочений промпт (~60% економії токенів: з ~450 до ~180 токенів)
  - Зменшення max_tokens до 1500 (з 2000) - економія ~25% на відповідях
  - Очікувана загальна економія: 60-70% токенів (з ~26k до ~8-10k на зображення)
- **Навігація**: 3-6 секунд (було 15-30+)
- **Навігація для текстового парсингу**: 1-2 секунди (галерея не чекається)
- **Gallery парсинг**: 5-6 секунд через JavaScript block (було 20-40 через кліки)
- **A+ парсинг**: 2-3 секунди через DOM-парсинг (було 9-10 через каруселі)
- **A+ парсинг без контенту**: ~0.1 секунди завдяки швидкій перевірці h2 заголовків (було 8-9 секунд)
- **Fallback до Selenium**: 0.5 секунди на селектор (було 2 секунди)
- **Текстовий парсинг**: ~15 секунд (було ~45 секунд)
- **Загальний час**: ~40 секунд для повного парсингу (було 2-3 хвилини)
- **Пам'ять**: Обмеження MD5 кешу для уникнення витоку пам'яті
- **База даних**: Автоматичне очищення старих задач

### Змінено

- **UI**: Об'єднано чекбокси "Product Description" та "Q&A" в один "Product Description + Q&A (якщо існує)"
- **UI**: Синхронізація чекбокса "Select All Images" з окремими чекбоксами зображень
- **Архітектура**: Видалено окремий Q&A агент, Q&A тепер парситься в text_parser
- **Архітектура**: Видалено Variant Detector Agent та всю функціональність варіантів
- **Структура проекту**: Додаткові скрипти переміщено в папку `scripts/`
- **Валідатор**: Перевіряє обов'язкові поля тексту тільки якщо текст був вибраний для парсингу
- **DOCX генерація**: "Product Information" додається тільки якщо є дані (brand, asin, price)
- **DOCX генерація**: Створюється навіть якщо вибрано тільки Customer Reviews

## [1.0.0] - 2025-01-XX

### Додано

- Початкова версія Multi-Agent Amazon Parser
- Flask веб-інтерфейс
- 6 агентів парсингу:
  - Image Parser Agent
  - Text Parser Agent
  - Customer Reviews Agent
  - Q&A Parser Agent
  - Variant Detector Agent
  - Validator Agent
- SQLite база даних для історії задач
- Генерація DOCX документів
- Anti-detection заходи (undetected-chromedriver)
- MD5 дедуплікація зображень
- Структурована файлова система для результатів

